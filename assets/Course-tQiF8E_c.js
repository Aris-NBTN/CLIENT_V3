import{a as A,u as I,v as P,r as l,s as U,dA as L,j as e,B as y,y as X,Q as $,I as R}from"./index-Bl_pZCeN.js";import{b as B}from"./index-Ch5hctbl.js";import{b7 as M}from"./Layout-Cr3VXxUG.js";import{V as W}from"./Video-BfdU3qEE.js";import{T as m}from"./index-Cil4O1hR.js";import{P as O}from"./index-CnsZvPuK.js";import{B as Q}from"./TextArea-BanZLPmh.js";import{R as _,C as u}from"./row-BAzrWk1M.js";import{C as v}from"./index-B5ETzEVc.js";import{E as F}from"./index-Bh9zOY6B.js";import{C as q}from"./Collapse-BpWqihoG.js";import"./index-FpgqAsqH.js";import"./EllipsisOutlined-Dv0U7LQh.js";import"./Overflow-B2U5bHyH.js";import"./context-CeT_YlOn.js";import"./index-CZycZjMr.js";import"./index-k6j_HrSw.js";import"./index-Bev9D8vS.js";import"./PurePanel-ryEM3orR.js";import"./useVariants-B1zc-sRz.js";import"./CheckOutlined-BPHqeFCx.js";import"./SearchOutlined-Bm-v0bMy.js";import"./useLocale-BY4459aG.js";import"./index-DK56_scK.js";import"./Dropdown-BgYRO9jp.js";import"./index-B65SxrxW.js";import"./styleChecker-Ck8JMnEb.js";import"./index-Cg5YuCgZ.js";import"./index-DjArs4z8.js";const Se=()=>{const f=A(),{slug:g}=I(),{token:{colorPrimary:C}}=P.useToken(),S=l.useRef(null),x=l.useRef(null),{user:a}=U(t=>t.auth),[b,E]=l.useState(!0),[o,H]=l.useState(null),[s,j]=l.useState(null),h={videoRef:l.useRef(null),modulesRef:l.useRef(null),contentRef:l.useRef(null)},K=[{placement:"right",title:"Video khóa học!",description:"Xem video để hiểu rõ hơn về khóa học!",target:()=>h.videoRef.current},{placement:"left",title:"Học phần!",description:"Trong học phần có nhiều bài học, hãy chọn bài học để học!",target:()=>h.modulesRef.current},{placement:"top",title:"Nội dung và ghi chú bài học!",description:"Hãy đọc kỹ nội dung và ghi chú bài học để hiểu nhiều kiến thức hơn!",target:()=>h.contentRef.current}],z=l.useCallback((t,i,n)=>{const r=t==null?void 0:t.find(c=>c.slug===n);return(r==null?void 0:r._id)||null},[]),w=l.useCallback((t,i)=>{if(!(t!=null&&t.video)||!i)return null;const r=t.video.filter(c=>c.watched).sort((c,d)=>new Date(d.updatedAt)-new Date(c.updatedAt))[0];if(!r)return null;for(const c of i)for(const d of c.children)if(d._id===r.videoId)return{...d,watchTime:r.watchTime};return null},[]),T=l.useCallback((t,i)=>!(t!=null&&t.module)||!i?t:{...t,module:t.module.map(n=>({...n,children:n.children.map(r=>{const c=i.find(d=>d.videoId===r._id);return{...r,watchTime:c?c.watchTime:void 0,watched:!!c}})}))},[]),N=l.useCallback(()=>{var t;if((t=s==null?void 0:s.content)!=null&&t.css){const i=document.createElement("style");return i.textContent=s.content.css,document.head.appendChild(i),()=>{document.head.removeChild(i)}}},[s]),k=l.useCallback(()=>{var t,i;if((t=s==null?void 0:s.content)!=null&&t.js){const n=`
                (function() {
                    try {
                        ${s.content.js}
                    } catch (error) {
                        console.error('Error in lesson script:', error);
                    }
                })();
            `,r=document.createElement("script");return r.type="text/javascript",r.textContent=n,(i=x.current)==null||i.appendChild(r),()=>{var c;(c=x.current)!=null&&c.contains(r)&&x.current.removeChild(r)}}},[s]);l.useEffect(()=>{const t=N(),i=k();return()=>{t&&t(),i&&i()}},[s,N,k]),l.useEffect(()=>{const t=async()=>{try{const i=await $.checkCourseUser({idUser:a._id,slugCourse:g});if(!i.module||i.module.length===0){R("courses","Không Thể Xem Khóa Học!","Khóa học này chưa có thông tin và video!"),f("/user/courses");return}const n=T(i,a.video),r=w(a,n.module);H(n),r!=null?j(r):j(n.module[0].children[0]),E(!1)}catch{R("courses","Không Thể Xem Khóa Học!","Khóa học không tồn tại hoặc bạn chưa mua khóa học này!"),f("/user/courses")}};a!=null&&a._id&&g&&t()},[a,f,g,z,T,w]),L(l.useCallback(()=>{(()=>{var n;const i=((n=S.current)==null?void 0:n.currentTime)||0;a!=null&&a._id&&(s!=null&&s._id)&&y.putVideo({id:a._id,videoId:s._id,watched:!0,watchTime:i}).catch(console.error)})()},[s,a]));const p=l.useMemo(()=>{var t;return(t=o==null?void 0:o.module)==null?void 0:t.map(i=>({key:i._id,label:e.jsx(m.Title,{level:5,strong:!0,className:"!mb-0",children:i.title}),extra:`${i.children.length} Bài Học`,children:i.children.map(n=>e.jsxs("div",{onClick:()=>{var r;j(n),(r=h.videoRef.current)==null||r.scrollIntoView({behavior:"smooth"}),n!=null&&n.src&&y.putVideo({id:a==null?void 0:a._id,videoId:n==null?void 0:n._id,watched:!0})},className:"flex justify-between cursor-pointer",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[n!=null&&n.watched?e.jsx(B,{color:C,size:20}):e.jsx(B,{size:20}),e.jsx(m.Title,{level:5,className:"!mb-0 p-2",children:n.title})]}),(s==null?void 0:s._id)===n._id&&e.jsx(m.Text,{type:"danger",className:"!mb-0 p-2",children:(n==null?void 0:n.src)&&e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1.2rem",height:"1.2rem",viewBox:"0 0 24 24",children:[e.jsxs("rect",{width:"6",height:"14",x:"1",y:"4",fill:"#ff0000",children:[e.jsx("animate",{id:"svgSpinnersBarsScaleFade0",fill:"freeze",attributeName:"y",begin:"0;svgSpinnersBarsScaleFade1.end-0.25s",dur:"0.75s",values:"1;5"}),e.jsx("animate",{fill:"freeze",attributeName:"height",begin:"0;svgSpinnersBarsScaleFade1.end-0.25s",dur:"0.75s",values:"22;14"}),e.jsx("animate",{fill:"freeze",attributeName:"opacity",begin:"0;svgSpinnersBarsScaleFade1.end-0.25s",dur:"0.75s",values:"1;0.2"})]}),e.jsxs("rect",{width:"6",height:"14",x:"9",y:"4",fill:"#ff0000",opacity:"0.4",children:[e.jsx("animate",{fill:"freeze",attributeName:"y",begin:"svgSpinnersBarsScaleFade0.begin+0.15s",dur:"0.75s",values:"1;5"}),e.jsx("animate",{fill:"freeze",attributeName:"height",begin:"svgSpinnersBarsScaleFade0.begin+0.15s",dur:"0.75s",values:"22;14"}),e.jsx("animate",{fill:"freeze",attributeName:"opacity",begin:"svgSpinnersBarsScaleFade0.begin+0.15s",dur:"0.75s",values:"1;0.2"})]}),e.jsxs("rect",{width:"6",height:"14",x:"17",y:"4",fill:"#ff0000",opacity:"0.3",children:[e.jsx("animate",{id:"svgSpinnersBarsScaleFade1",fill:"freeze",attributeName:"y",begin:"svgSpinnersBarsScaleFade0.begin+0.3s",dur:"0.75s",values:"1;5"}),e.jsx("animate",{fill:"freeze",attributeName:"height",begin:"svgSpinnersBarsScaleFade0.begin+0.3s",dur:"0.75s",values:"22;14"}),e.jsx("animate",{fill:"freeze",attributeName:"opacity",begin:"svgSpinnersBarsScaleFade0.begin+0.3s",dur:"0.75s",values:"1;0.2"})]})]})})]},n._id))}))},[o,C,s,a]);return e.jsx(M,{title:(o==null?void 0:o.name)||"Khóa học của tôi",tours:K,header:"KHÓA HỌC CỦA TÔI",button:e.jsx(e.Fragment,{children:e.jsx(O,{placement:"left",title:"Xác nhận học lại khóa học?",description:"Bạn có chắc chắn muốn học lại khóa học này không?",onConfirm:()=>{y.putUser({id:a==null?void 0:a._id,video:[]})},children:e.jsx(Q,{children:"Học Lại Khóa Học"})})}),children:e.jsxs(_,{gutter:[24,24],children:[e.jsx(u,{xxl:{span:16},xl:{span:15},lg:{span:14},md:{span:24},span:24,children:e.jsxs(_,{gutter:[24,24],children:[e.jsx(u,{span:24,children:e.jsx(v,{loading:b,title:e.jsx(m.Title,{level:3,className:"!mb-0",children:(o==null?void 0:o.name)||"Khóa học của tôi"}),ref:h.videoRef,children:s!=null&&s.src?e.jsx(W,{className:"video-aris",mediaPlayerRef:S,iduser:a==null?void 0:a._id,videoId:s._id,autoPlay:!0,time:s.watchTime,src:`${X}/uploads/${s.src}`}):e.jsx(F,{description:"Chưa có video được tải lên!"})})}),e.jsx(u,{span:24,children:e.jsx(v,{className:"mb-0 lg:mb-6",loading:b,ref:h.contentRef,title:e.jsx(m.Title,{className:"!mb-0",level:3,children:s==null?void 0:s.title}),children:s!=null&&s.content?e.jsx(e.Fragment,{children:e.jsx("div",{dangerouslySetInnerHTML:{__html:s.content.html}})}):e.jsx(F,{description:"Chưa có nội dung được tải lên!"})})})]})}),e.jsx(u,{xxl:{span:8},xl:{span:9},lg:{span:10},md:{span:24},span:24,children:e.jsx(v,{className:"!mb-6",loading:b,title:e.jsx(m.Title,{level:3,className:"!mb-0",children:"Nội Dung Khóa Học"}),ref:h.modulesRef,children:e.jsx(q,{expandIconPosition:"start",items:p,defaultActiveKey:p==null?void 0:p.map(t=>t.key)})})})]})})};export{Se as default};
